"""Check if a host is in the Google Chrome HSTS Preload list"""

import functools
import os
import typing

__version__ = "2020.9.9"
__checksum__ = "af1d21884bed7befefa95939bad72f140072e1b167f6ec36f0ef19e5a5d311e3"
__all__ = ["in_hsts_preload"]

# fmt: off
_GTLD_INCLUDE_SUBDOMAINS = {b'android', b'app', b'bank', b'chrome', b'dev', b'foo', b'gle', b'gmail', b'google', b'hangout', b'insurance', b'meet', b'new', b'page', b'play', b'search', b'youtube'}  # noqa: E501
_JUMPTABLE = [[(0, 11), (11, 5), None, (16, 57), (73, 26), (99, 12), None, (111, 19), (130, 22), (152, 7), (159, 20), (179, 18), None, (197, 22), (219, 45), (264, 7), (271, 9), (280, 36), (316, 10), (326, 10), (336, 21), None, (357, 50), (407, 8), (415, 9), (424, 19), (443, 13), (456, 14), (470, 14), None, None, (484, 29), (513, 16), (529, 35), (564, 14), (578, 24), (602, 9), None, (611, 25), (636, 20), (656, 8), (664, 13), (677, 10), None, (687, 17), (704, 6), (710, 26), (736, 5), (741, 5), (746, 10), (756, 10), (766, 11), (777, 12), (789, 27), None, (816, 11), (827, 11), (838, 7), (845, 29), (874, 18), (892, 27), (919, 46), (965, 25), (990, 16), (1006, 8), (1014, 5), (1019, 22), (1041, 18), None, (1059, 36), (1095, 15), (1110, 8), (1118, 11), None, (1129, 5), (1134, 16), (1150, 14), (1164, 18), None, (1182, 14), (1196, 18), (1214, 48), (1262, 19), (1281, 5), (1286, 46), (1332, 14), (1346, 14), (1360, 20), None, (1380, 10), (1390, 13), (1403, 10), (1413, 19), None, (1432, 13), (1445, 19), (1464, 5), (1469, 4), (1473, 22), (1495, 10), (1505, 7), (1512, 14), (1526, 21), (1547, 11), (1558, 10), (1568, 12), (1580, 32), None, (1612, 10), (1622, 14), (1636, 12), (1648, 45), (1693, 15), None, (1708, 11), (1719, 23), (1742, 21), (1763, 26), (1789, 6), (1795, 6), (1801, 7), (1808, 5), (1813, 20), (1833, 23), (1856, 24), (1880, 13), (1893, 15), (1908, 19), (1927, 6), (1933, 61), (1994, 44), (2038, 12), (2050, 23), (2073, 16), (2089, 38), (2127, 6), (2133, 12), (2145, 44), (2189, 6), (2195, 41), (2236, 13), (2249, 23), (2272, 30), (2302, 16), (2318, 8), (2326, 15), (2341, 12), (2353, 19), (2372, 21), (2393, 15), None, (2408, 35), (2443, 21), (2464, 17), (2481, 19), (2500, 26), (2526, 5), (2531, 37), (2568, 30), (2598, 16), (2614, 10), (2624, 17), (2641, 23), (2664, 14), (2678, 17), (2695, 8), (2703, 4), (2707, 7), (2714, 29), (2743, 6), (2749, 18), (2767, 27), (2794, 20), (2814, 17), (2831, 19), (2850, 12), (2862, 40), (2902, 40), (2942, 12), (2954, 48), (3002, 25), (3027, 12), None, (3039, 8), (3047, 20), (3067, 19), (3086, 6), (3092, 23), None, (3115, 30), (3145, 33), (3178, 14), (3192, 12), (3204, 27), None, (3231, 26), (3257, 31), (3288, 50), (3338, 15), (3353, 20), (3373, 15), (3388, 21), (3409, 32), (3441, 24), (3465, 20), (3485, 13), (3498, 60), (3558, 19), (3577, 9), (3586, 12), (3598, 12), (3610, 11), (3621, 10), (3631, 48), (3679, 32), None, (3711, 25), (3736, 12), None, (3748, 8), (3756, 8), (3764, 7), None, (3771, 25), (3796, 17), None, (3813, 21), (3834, 35), (3869, 12), (3881, 10), (3891, 36), (3927, 20), (3947, 22), (3969, 23), (3992, 19), (4011, 12), (4023, 5), (4028, 30), (4058, 24), (4082, 14), (4096, 14), (4110, 47), (4157, 46), None, None, (4203, 51), (4254, 42), None, (4296, 14), None, (4310, 15), (4325, 8), (4333, 21), (4354, 6), (4360, 16), (4376, 17)], [(4393, 6316), (10709, 6782), (17491, 7155), (24646, 6062), (30708, 6400), (37108, 6171), (43279, 6986), (50265, 6365), (56630, 6941), (63571, 6144), (69715, 7179), (76894, 6557), (83451, 6777), (90228, 7220), (97448, 6596), (104044, 6487), (110531, 7094), (117625, 6015), (123640, 6386), (130026, 6607), (136633, 7022), (143655, 6665), (150320, 6972), (157292, 6197), (163489, 6493), (169982, 6708), (176690, 6668), (183358, 7010), (190368, 6378), (196746, 6780), (203526, 6933), (210459, 6605), (217064, 6525), (223589, 7126), (230715, 6253), (236968, 6901), (243869, 6258), (250127, 7076), (257203, 6866), (264069, 6997), (271066, 7617), (278683, 6462), (285145, 6381), (291526, 6241), (297767, 6395), (304162, 6237), (310399, 6454), (316853, 7112), (323965, 6530), (330495, 5987), (336482, 6518), (343000, 6716), (349716, 6642), (356358, 6827), (363185, 6905), (370090, 6900), (376990, 6933), (383923, 6029), (389952, 7014), (396966, 5921), (402887, 6722), (409609, 6502), (416111, 6426), (422537, 6917), (429454, 6704), (436158, 6616), (442774, 6308), (449082, 7171), (456253, 6784), (463037, 6819), (469856, 6593), (476449, 6621), (483070, 5769), (488839, 7105), (495944, 7191), (503135, 7171), (510306, 6190), (516496, 7301), (523797, 7104), (530901, 6117), (537018, 6825), (543843, 5785), (549628, 6510), (556138, 6675), (562813, 6515), (569328, 6466), (575794, 6702), (582496, 6686), (589182, 6889), (596071, 6653), (602724, 7327), (610051, 6095), (616146, 6376), (622522, 6646), (629168, 6525), (635693, 7164), (642857, 6980), (649837, 6483), (656320, 6264), (662584, 6243), (668827, 6324), (675151, 6811), (681962, 6279), (688241, 6597), (694838, 6298), (701136, 6943), (708079, 6702), (714781, 7163), (721944, 8087), (730031, 7176), (737207, 7020), (744227, 6547), (750774, 6384), (757158, 6726), (763884, 6983), (770867, 6788), (777655, 6301), (783956, 6420), (790376, 6408), (796784, 7170), (803954, 6889), (810843, 6975), (817818, 7058), (824876, 6970), (831846, 7894), (839740, 6470), (846210, 5913), (852123, 6962), (859085, 6623), (865708, 8118), (873826, 7149), (880975, 6180), (887155, 6849), (894004, 6884), (900888, 6363), (907251, 6803), (914054, 6268), (920322, 6857), (927179, 6526), (933705, 6587), (940292, 6653), (946945, 7316), (954261, 6358), (960619, 6319), (966938, 6663), (973601, 6628), (980229, 6608), (986837, 6882), (993719, 6340), (1000059, 7235), (1007294, 6724), (1014018, 6784), (1020802, 6930), (1027732, 6566), (1034298, 6690), (1040988, 6667), (1047655, 6471), (1054126, 6552), (1060678, 6348), (1067026, 6071), (1073097, 6278), (1079375, 6749), (1086124, 7290), (1093414, 6221), (1099635, 6670), (1106305, 6969), (1113274, 6461), (1119735, 6219), (1125954, 7038), (1132992, 6602), (1139594, 6069), (1145663, 6549), (1152212, 7787), (1159999, 6194), (1166193, 6310), (1172503, 6839), (1179342, 6467), (1185809, 6775), (1192584, 6458), (1199042, 6089), (1205131, 7537), (1212668, 6886), (1219554, 6567), (1226121, 7056), (1233177, 7479), (1240656, 7366), (1248022, 6235), (1254257, 7019), (1261276, 6353), (1267629, 6641), (1274270, 6837), (1281107, 6258), (1287365, 6976), (1294341, 7147), (1301488, 6679), (1308167, 6745), (1314912, 6520), (1321432, 6559), (1327991, 6819), (1334810, 6414), (1341224, 6748), (1347972, 6134), (1354106, 7161), (1361267, 6922), (1368189, 6675), (1374864, 7044), (1381908, 5881), (1387789, 6755), (1394544, 6584), (1401128, 6939), (1408067, 6922), (1414989, 7189), (1422178, 6757), (1428935, 6954), (1435889, 6939), (1442828, 6488), (1449316, 6627), (1455943, 6616), (1462559, 6685), (1469244, 6535), (1475779, 6590), (1482369, 6064), (1488433, 7587), (1496020, 6767), (1502787, 6360), (1509147, 6662), (1515809, 6818), (1522627, 5990), (1528617, 6830), (1535447, 6632), (1542079, 7573), (1549652, 6536), (1556188, 6074), (1562262, 7087), (1569349, 6417), (1575766, 7293), (1583059, 6295), (1589354, 6331), (1595685, 5877), (1601562, 6706), (1608268, 6564), (1614832, 6925), (1621757, 6392), (1628149, 6622), (1634771, 6589), (1641360, 7167), (1648527, 6476), (1655003, 5921), (1660924, 6670), (1667594, 6328), (1673922, 6817), (1680739, 6996), (1687735, 7119), (1694854, 6326), (1701180, 6331), (1707511, 6799)], [(1714310, 722), (1715032, 625), (1715657, 665), (1716322, 740), (1717062, 553), (1717615, 649), (1718264, 671), (1718935, 836), (1719771, 640), (1720411, 667), (1721078, 536), (1721614, 574), (1722188, 758), (1722946, 853), (1723799, 1006), (1724805, 794), (1725599, 1224), (1726823, 653), (1727476, 875), (1728351, 673), (1729024, 741), (1729765, 746), (1730511, 853), (1731364, 731), (1732095, 703), (1732798, 686), (1733484, 955), (1734439, 1131), (1735570, 807), (1736377, 734), (1737111, 922), (1738033, 787), (1738820, 568), (1739388, 746), (1740134, 748), (1740882, 789), (1741671, 659), (1742330, 726), (1743056, 746), (1743802, 1085), (1744887, 695), (1745582, 812), (1746394, 727), (1747121, 719), (1747840, 728), (1748568, 378), (1748946, 908), (1749854, 870), (1750724, 735), (1751459, 568), (1752027, 834), (1752861, 671), (1753532, 780), (1754312, 1012), (1755324, 944), (1756268, 558), (1756826, 661), (1757487, 527), (1758014, 578), (1758592, 751), (1759343, 772), (1760115, 776), (1760891, 1054), (1761945, 915), (1762860, 706), (1763566, 719), (1764285, 767), (1765052, 475), (1765527, 595), (1766122, 556), (1766678, 692), (1767370, 877), (1768247, 596), (1768843, 725), (1769568, 650), (1770218, 702), (1770920, 573), (1771493, 688), (1772181, 787), (1772968, 461), (1773429, 754), (1774183, 629), (1774812, 828), (1775640, 623), (1776263, 603), (1776866, 425), (1777291, 597), (1777888, 725), (1778613, 781), (1779394, 780), (1780174, 853), (1781027, 1092), (1782119, 826), (1782945, 856), (1783801, 725), (1784526, 436), (1784962, 955), (1785917, 842), (1786759, 580), (1787339, 671), (1788010, 728), (1788738, 870), (1789608, 855), (1790463, 571), (1791034, 632), (1791666, 756), (1792422, 395), (1792817, 466), (1793283, 924), (1794207, 897), (1795104, 831), (1795935, 793), (1796728, 654), (1797382, 792), (1798174, 659), (1798833, 699), (1799532, 709), (1800241, 469), (1800710, 705), (1801415, 692), (1802107, 914), (1803021, 679), (1803700, 804), (1804504, 461), (1804965, 703), (1805668, 755), (1806423, 835), (1807258, 908), (1808166, 781), (1808947, 926), (1809873, 802), (1810675, 524), (1811199, 795), (1811994, 615), (1812609, 803), (1813412, 747), (1814159, 717), (1814876, 681), (1815557, 635), (1816192, 673), (1816865, 621), (1817486, 674), (1818160, 694), (1818854, 632), (1819486, 494), (1819980, 603), (1820583, 661), (1821244, 577), (1821821, 717), (1822538, 594), (1823132, 773), (1823905, 514), (1824419, 510), (1824929, 678), (1825607, 612), (1826219, 642), (1826861, 639), (1827500, 870), (1828370, 610), (1828980, 622), (1829602, 874), (1830476, 848), (1831324, 560), (1831884, 695), (1832579, 854), (1833433, 659), (1834092, 675), (1834767, 455), (1835222, 609), (1835831, 660), (1836491, 788), (1837279, 598), (1837877, 932), (1838809, 708), (1839517, 807), (1840324, 721), (1841045, 668), (1841713, 586), (1842299, 664), (1842963, 720), (1843683, 1353), (1845036, 575), (1845611, 662), (1846273, 650), (1846923, 1027), (1847950, 771), (1848721, 781), (1849502, 546), (1850048, 587), (1850635, 823), (1851458, 601), (1852059, 589), (1852648, 828), (1853476, 650), (1854126, 911), (1855037, 810), (1855847, 735), (1856582, 710), (1857292, 868), (1858160, 637), (1858797, 909), (1859706, 644), (1860350, 776), (1861126, 586), (1861712, 742), (1862454, 483), (1862937, 828), (1863765, 823), (1864588, 665), (1865253, 916), (1866169, 775), (1866944, 849), (1867793, 920), (1868713, 1077), (1869790, 863), (1870653, 648), (1871301, 877), (1872178, 731), (1872909, 508), (1873417, 443), (1873860, 794), (1874654, 787), (1875441, 438), (1875879, 1007), (1876886, 488), (1877374, 778), (1878152, 863), (1879015, 792), (1879807, 784), (1880591, 696), (1881287, 788), (1882075, 728), (1882803, 784), (1883587, 607), (1884194, 579), (1884773, 408), (1885181, 666), (1885847, 484), (1886331, 798), (1887129, 855), (1887984, 764), (1888748, 718), (1889466, 658), (1890124, 604), (1890728, 848), (1891576, 495), (1892071, 606), (1892677, 780), (1893457, 494), (1893951, 870), (1894821, 2090), (1896911, 548), (1897459, 707), (1898166, 890), (1899056, 912), (1899968, 510)], [(1900478, 48), None, (1900526, 35), (1900561, 42), None, None, None, None, None, None, None, None, None, None, None, None, None, (1900603, 42), None, (1900645, 25), (1900670, 44), (1900714, 22), (1900736, 18), None, None, None, None, (1900754, 26), None, None, None, None, (1900780, 21), (1900801, 25), None, None, (1900826, 26), None, None, None, None, (1900852, 44), (1900896, 21), (1900917, 23), None, None, None, None, (1900940, 48), None, None, None, None, None, (1900988, 31), None, None, None, None, (1901019, 42), None, (1901061, 22), None, (1901083, 21), None, (1901104, 26), (1901130, 42), None, None, (1901172, 77), None, None, None, None, None, (1901249, 21), (1901270, 21), None, None, (1901291, 34), (1901325, 42), None, None, None, (1901367, 25), None, None, (1901392, 21), None, None, None, None, None, (1901413, 24), (1901437, 21), None, None, (1901458, 26), None, (1901484, 18), None, (1901502, 54), None, None, None, None, None, None, (1901556, 26), None, (1901582, 19), None, (1901601, 20), None, None, (1901621, 42), (1901663, 42), (1901705, 17), None, (1901722, 26), None, (1901748, 26), None, None, None, (1901774, 26), (1901800, 20), (1901820, 26), None, (1901846, 42), (1901888, 63), None, None, None, (1901951, 40), (1901991, 48), None, None, None, (1902039, 47), None, None, None, None, None, None, None, (1902086, 42), None, (1902128, 55), None, (1902183, 9), None, (1902192, 21), (1902213, 42), None, None, (1902255, 42), (1902297, 82), None, None, (1902379, 42), None, None, None, None, None, None, None, None, None, (1902421, 42), (1902463, 21), (1902484, 21), None, (1902505, 42), (1902547, 25), None, None, (1902572, 21), (1902593, 42), None, None, (1902635, 21), (1902656, 19), (1902675, 26), None, None, None, (1902701, 21), None, None, (1902722, 38), None, (1902760, 22), (1902782, 21), (1902803, 21), None, None, (1902824, 63), None, (1902887, 21), (1902908, 42), None, (1902950, 17), None, None, None, None, (1902967, 21), (1902988, 21), None, None, (1903009, 21), None, None, (1903030, 21), None, (1903051, 26), None, (1903077, 50), None, None, None, (1903127, 50), (1903177, 26), (1903203, 21), (1903224, 21), (1903245, 19), None, (1903264, 35), (1903299, 26), (1903325, 23), (1903348, 21), (1903369, 42), None, None, None, None, None, None, (1903411, 21), None, None, None, (1903432, 21), None, None, (1903453, 90), None, (1903543, 239), (1903782, 38), None, None, None, None]]  # noqa: E501
_CRC8_TABLE = [
    0x00, 0x07, 0x0e, 0x09, 0x1c, 0x1b, 0x12, 0x15,
    0x38, 0x3f, 0x36, 0x31, 0x24, 0x23, 0x2a, 0x2d,
    0x70, 0x77, 0x7e, 0x79, 0x6c, 0x6b, 0x62, 0x65,
    0x48, 0x4f, 0x46, 0x41, 0x54, 0x53, 0x5a, 0x5d,
    0xe0, 0xe7, 0xee, 0xe9, 0xfc, 0xfb, 0xf2, 0xf5,
    0xd8, 0xdf, 0xd6, 0xd1, 0xc4, 0xc3, 0xca, 0xcd,
    0x90, 0x97, 0x9e, 0x99, 0x8c, 0x8b, 0x82, 0x85,
    0xa8, 0xaf, 0xa6, 0xa1, 0xb4, 0xb3, 0xba, 0xbd,
    0xc7, 0xc0, 0xc9, 0xce, 0xdb, 0xdc, 0xd5, 0xd2,
    0xff, 0xf8, 0xf1, 0xf6, 0xe3, 0xe4, 0xed, 0xea,
    0xb7, 0xb0, 0xb9, 0xbe, 0xab, 0xac, 0xa5, 0xa2,
    0x8f, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9d, 0x9a,
    0x27, 0x20, 0x29, 0x2e, 0x3b, 0x3c, 0x35, 0x32,
    0x1f, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0d, 0x0a,
    0x57, 0x50, 0x59, 0x5e, 0x4b, 0x4c, 0x45, 0x42,
    0x6f, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7d, 0x7a,
    0x89, 0x8e, 0x87, 0x80, 0x95, 0x92, 0x9b, 0x9c,
    0xb1, 0xb6, 0xbf, 0xb8, 0xad, 0xaa, 0xa3, 0xa4,
    0xf9, 0xfe, 0xf7, 0xf0, 0xe5, 0xe2, 0xeb, 0xec,
    0xc1, 0xc6, 0xcf, 0xc8, 0xdd, 0xda, 0xd3, 0xd4,
    0x69, 0x6e, 0x67, 0x60, 0x75, 0x72, 0x7b, 0x7c,
    0x51, 0x56, 0x5f, 0x58, 0x4d, 0x4a, 0x43, 0x44,
    0x19, 0x1e, 0x17, 0x10, 0x05, 0x02, 0x0b, 0x0c,
    0x21, 0x26, 0x2f, 0x28, 0x3d, 0x3a, 0x33, 0x34,
    0x4e, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5c, 0x5b,
    0x76, 0x71, 0x78, 0x7f, 0x6a, 0x6d, 0x64, 0x63,
    0x3e, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2c, 0x2b,
    0x06, 0x01, 0x08, 0x0f, 0x1a, 0x1d, 0x14, 0x13,
    0xae, 0xa9, 0xa0, 0xa7, 0xb2, 0xb5, 0xbc, 0xbb,
    0x96, 0x91, 0x98, 0x9f, 0x8a, 0x8d, 0x84, 0x83,
    0xde, 0xd9, 0xd0, 0xd7, 0xc2, 0xc5, 0xcc, 0xcb,
    0xe6, 0xe1, 0xe8, 0xef, 0xfa, 0xfd, 0xf4, 0xf3
]
# fmt: on

_IS_LEAF = 0x80
_INCLUDE_SUBDOMAINS = 0x40


try:
    from importlib.resources import open_binary

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open_binary("hstspreload", path)


except ImportError:

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open(
            os.path.join(os.path.dirname(os.path.abspath(__file__)), path),
            "rb",
        )


@functools.lru_cache(maxsize=1024)
def in_hsts_preload(host: typing.AnyStr) -> bool:
    """Determines if an IDNA-encoded host is on the HSTS preload list"""

    if isinstance(host, str):
        host = host.encode("ascii")
    labels = host.lower().split(b".")

    # Fast-branch for gTLDs that are registered to preload all sub-domains.
    if labels[-1] in _GTLD_INCLUDE_SUBDOMAINS:
        return True

    with open_pkg_binary("hstspreload.bin") as f:
        for layer, label in enumerate(labels[::-1]):
            # None of our layers are greater than 4 deep.
            if layer > 3:
                return False

            # Read the jump table for the layer and label
            jump_info = _JUMPTABLE[layer][_crc8(label)]
            if jump_info is None:
                # No entry: host is not preloaded
                return False

            # Read the set of entries for that layer and label
            f.seek(jump_info[0])
            data = bytearray(jump_info[1])
            f.readinto(data)

            for is_leaf, include_subdomains, ent_label in _iter_entries(data):
                # We found a potential leaf
                if is_leaf:
                    if ent_label == host:
                        return True
                    if include_subdomains and host.endswith(b"." + ent_label):
                        return True

                # Continue traversing as we're not at a leaf.
                elif label == ent_label:
                    break
            else:
                return False
    return False


def _iter_entries(data: bytes) -> typing.Iterable[typing.Tuple[int, int, bytes]]:
    while data:
        flags = data[0]
        size = data[1]
        label = bytes(data[2 : 2 + size])
        yield (flags & _IS_LEAF, flags & _INCLUDE_SUBDOMAINS, label)
        data = data[2 + size :]


def _crc8(value: bytes) -> int:
    # CRC8 reference implementation: https://github.com/niccokunzmann/crc8
    checksum = 0x00
    for byte in value:
        checksum = _CRC8_TABLE[checksum ^ byte]
    return checksum
