{% from 'link_row.html' import link_row with context %}
{% extends 'base.html' %}
{% block content %}

{% if wrong_owner %}
<div class="shrunk-messages">
	You are not the owner of this URL...
</div>
{% endif %}

<div class="row row-controls">
	<div class="col col-md-auto">
		<h2>URL Dashboard</h2>
	</div>

	{# Add Link dropdown menu #}
	<div class="col col-md-auto">
		<div class="dropdown" id="add-link-dropdown">
			<button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
				<i class="fas fa-plus-circle"></i> Add Link
			</button>

			<div class="dropdown-menu">
				<form class="px-4 py-3 needs-validation ajax-form" data-ajax-endpoint="{{ url_for('shrunk.add_link') }}"
					novalidate>
					<div class="form-group row">
						<input type="text" name="title" class="form-control" required="true" placeholder="Title">
						<div class="invalid-feedback"></div>
					</div>

					<div class="form-group row">
						<input type="text" name="long_url" class="form-control" required="true" placeholder="URL">
						<div class="invalid-feedback"></div>
					</div>

					<div class="form-group row">
						<div class="input-group date expiration-time-input" data-target-input="nearest">
							<input type="text" class="form-control datetimepicker-input" placeholder="Expiration time"
								name="expiration_time" data-target=".expiration-time-input" />
							<div class="invalid-feedback"></div>
							<div class="input-group-append" data-target=".expiration-time-input"
								data-toggle="datetimepicker">
								<div class="input-group-text"><i class="fa fa-calendar"></i></div>
							</div>
						</div>
					</div>

					{% if "admin" in roles or "power_user" in roles %}
					<div class="form-group row">
						<input type="text" name="short_url" class="form-control" placeholder="Alias (optional)">
						<div class="invalid-feedback"></div>
					</div>
					{% else %}
					<div class="row">
						<div class="col">
							<span>For information about creating custom short URLs, please see
								<a href="{{ url_for('shrunk.faq') }}#power_user">the FAQ</a>.</span>
						</div>
					</div>
					{% endif %}

					<button class="btn btn-primary" type="button">
						Shrink
					</button>
				</form>
			</div>
		</div>
	</div>

	<div class="col text-right">
		<form action="{{ url_for('stat.search-csv') }}">
			<button type="submit"
				class="btn btn-outline-primary btn-no-border btn-no-background btn-csv-download bg-light">
				<i class="fas fa-download"></i> Export visits of search results as CSV
			</button>
		</form>
	</div>
</div>

{% if query and not links %}
<div class="row">
	<div class="col">
		<div class="shrunk-messages">
			No results found for query <strong>{{ query }}</strong>
		</div>
	</div>
</div>
{% endif %}

{% if links %}
<div class="container rows-container">
	{% for link in links %}
	{{ link_row(link) }}
	{% endfor %}
</div>

{% if lastpage and lastpage > 1 %}
<nav aria-label="Search results pages">
	<ul class="pagination justify-content-center">
		<li class="page-item {{ 'disabled' if page == 1 else '' }}">
			<a class="page-link" aria-label="Previous" href="{{ url_for('shrunk.render_index', page=page-1) }}">
				<span aria-hidden="true">&laquo;</span>
				<span class="sr-only">Previous</span>
			</a>
		</li>

		{% if begin_pages != 1 %}
		<li class="page-item">
			<a class="page-link" aria-label="Page 1" href="{{ url_for('shrunk.render_index', page=1) }}">
				1
			</a>
		</li>

		<li class="page-item disabled">
			<a class="page-link" aria-label="Ellipsis">
				...
			</a>
		</li>
		{% endif %}

		{% for page_number in range(begin_pages, end_pages+1) %}
		{% set maybe_active = 'active' if page_number == page else '' %}
		<li class="page-item {{ maybe_active }}">
			<a class="page-link" aria-label="Page {{ page_number }}"
				href="{{ url_for('shrunk.render_index', page=page_number) }}">
				{{ page_number }}
			</a>
		</li>
		{% endfor %}

		{% if end_pages != lastpage %}
		<li class="page-item disabled">
			<a class="page-link" aria-label="Ellipsis">
				...
			</a>
		</li>

		<li class="page-time">
			<a class="page-link" aria-label="Page {{ lastpage }}"
				href="{{ url_for('shrunk.render_index', page=lastpage) }}">
				{{ lastpage }}
			</a>
		</li>
		{% endif %}

		<li class="page-item {{ 'disabled' if page == lastpage else '' }}">
			<a class="page-link" aria-label="Next" href="{{ url_for('shrunk.render_index', page=page+1) }}">
				<span aria-hidden="true">&raquo;</span>
				<span class="sr-only">Next</span>
			</a>
		</li>
	</ul>
</nav>
{% endif %}

{% endif %}

{# The QR code modal #}
<div id="qr-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<h4 id="qr_title">QR code for <em id="qr-url"></em></h4>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>

			<div class="qr modal-body">
				<div class="row">
					<div class="col">
						<canvas id="qr-canvas"></canvas>
					</div>
				</div>

				<div class="row">
					<div class="col">
						<div class="btn-group" role="group" aria-label="Print or download">
							<button id="qr-print" type="button" class="btn btn-primary btn-qr">
								Print
							</button>

							<button id="qr-download" type="button" class="btn btn-primary btn-qr">
								Download
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

{# The delete confirmation modal #}
<div id="delete-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<h4>Are you sure you want to delete this link?</h4>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>

			<div class="modal-body">
				This operation cannot be undone.

				<form class="ajax-form" data-ajax-endpoint="{{ url_for('shrunk.delete_link') }}">
					<input id="delete-short-url" type="hidden" name="short_url" value="">
					<button type="button" class="btn btn-primary float-right">
						Delete
					</button>
				</form>

				<button type="button" class="btn btn-secondary float-right" data-dismiss="modal">
					Cancel
				</button>
			</div>
		</div>
	</div>
</div>

{# The edit link modal #}
<div id="edit-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header edit-link-modal-header">
				<h4 class="edit-link-title"></h4>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>

			<div class="modal-body">
				<form class="px-4 py-3 needs-validation ajax-form"
					data-ajax-endpoint="{{ url_for('shrunk.edit_link') }}" novalidate>
					<input type="hidden" name="old_short_url">
					<div class="form-group row" data-clear="true">
						<input type="text" class="form-control" name="title" placeholder="Title">
						<div class="invalid-feedback"></div>
					</div>
					<div class="form-group row" data-clear="true">
						<input type="text" class="form-control" name="long_url" placeholder="URL">
						<div class="invalid-feedback"></div>
					</div>
					<div class="form-group row">
						<div class="input-group date expiration-time-input" data-target-input="nearest">
							<input type="text" class="form-control datetimepicker-input" placeholder="Expiration time"
								name="expiration_time" data-target=".expiration-time-input" />
							<div class="invalid-feedback"></div>
							<div class="input-group-append" data-target=".expiration-time-input"
								data-toggle="datetimepicker">
								<div class="input-group-text"><i class="fa fa-calendar"></i></div>
							</div>
						</div>
					</div>
					<div class="form-group row" data-clear="true">
						<input type="text" class="form-control" name="short_url" placeholder="Alias"
							{% if "power_user" not in roles and "admin" not in roles %} disabled {% endif %}>
						<div class="invalid-feedback"></div>
					</div>
					<div class="row">
						<div class="col">
							<button class="btn btn-secondary edit-link-button" type="button" data-dismiss="modal">
								Cancel
							</button>
						</div>

						<div class="col">
							<button class="btn btn-primary edit-link-button" type="button">
								Save
							</button>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

{{ bundle('style') }}
{{ bundle('index') }}

{% endblock %}